# Variable selection

library("data.table")
library(dplyr)
library(dummy)
library(caTools)
library(naniar)
library(VIM)
library("FSelector")
library(corrplot)

basetable<-read.csv("basetable3.csv")
basetable<-basetable[,-c(1)]
basetable$HasDetections<-as.factor(basetable$HasDetections)
# Subsetting data
set.seed(1000)
sample_rows = sample.split(basetable$HasDetections, SplitRatio=0.1)
basetable1 = basetable[ sample_rows,]

# Split the data into train/test
data_split <- sample(1:nrow(basetable1), round((nrow(basetable1)*0.7)))
train <- basetable1[data_split, ]  # 70%
test <- basetable1[-data_split, ]  # 30%

## Stepwise regresion
reg0<-glm(HasDetections~1,data=train,family=binomial)
reg1<-glm(HasDetections~.,data=train,family=binomial)
stepwise<-step(reg0,scope=formula(reg1),direction="both",k=2)  


# Significant variables (11 variables selected):
variables<-(SmartScreen_WOE + Freq_AVProductStatesIdentifier + 
              Census_FlightRing_WOE + EngineVersion_WOE + Census_OSUILocaleIdentifier + 
              Census_IsVirtualDevice + Census_GenuineStateName_WOE + Census_OSVersion_WOE + 
              Census_OSInstallTypeName_WOE + UacLuaenable + Freq_CityIdentifier)

# Subsetting with significant variables
data<-basetable[,c("SmartScreen_WOE" , "Freq_AVProductStatesIdentifier" , 
                     "Census_FlightRing_WOE" , "EngineVersion_WOE" , "Census_OSUILocaleIdentifier" , 
                     "Census_IsVirtualDevice" , "Census_GenuineStateName_WOE" , "Census_OSVersion_WOE" , 
                     "Census_OSInstallTypeName_WOE" , "UacLuaenable" , "Freq_CityIdentifier","HasDetections")]



# Another method for variable selection
train_task <- makeClassifTask(id ='Train', data=train, target='HasDetections')
test_task <- makeClassifTask(id='Test', data=test, target='HasDetections')
train_task <- normalizeFeatures(train_task,method = "standardize")
test_task <- normalizeFeatures(test_task,method = "standardize")
im_feat <- generateFilterValuesData(train_task, method = c("information.gain","chi.squared"))
plotFilterValues(im_feat,n.show = 30)
variable_order<-im_feat$data

# Subsetting with significant variables
data<-basetable[,c("MachineIdentifier", "SmartScreen_WOE", "Freq_AVProductStatesIdentifier","AVProductsInstalled","EngineVersion_WOE","AppVersion_WOE",
                   "Freq_AvSigVersion","OsBuildLab_WOE","GeoNameIdentifier","Census_InternalPrimaryDiagonalDisplaySizeInInches","Census_FirmwareManufacturerIdentifier",
                   "Processor_WOE","Census_OSArchitecture_WOE","Census_OSVersion_WOE","Census_InternalPrimaryDisplayResolutionVertical","Census_MDC2FormFactor_WOE",
                   "IeVerIdentifier","IsProtected","Census_ProcessorCoreCount","Census_ChassisTypeName_WOE","Census_IsAlwaysOnAlwaysConnectedCapable","Census_PowerPlatformRoleName_WOE",
                   "AVProductsEnabled","RtpStateBitfield","Census_OSInstallLanguageIdentifier", "HasDetections")]
# Saving new basetable
write.csv(data, "basetable4.csv")

# Variable correlation

options(scipen = 999)
data<- data.frame(lapply(data,as.numeric))
correlation<-cor(data)

corrplot(correlation, method="circle")
